# 정규화 데이터 연동 방안

## 🎯 목표

정규화된 분양가/옵션 데이터를 매물관리 시트에서 자동으로 가져와 입력하기

---

## 📋 방법 1: IMPORTRANGE + VLOOKUP (권장)

### 장점
- ✅ 코드 없이 수식만으로 구현
- ✅ 실시간 동기화
- ✅ 데이터 소스 분리 가능

### 단점
- ⚠️ 첫 연결 시 권한 승인 필요
- ⚠️ 복잡한 조건 매칭 시 수식 복잡

### 구현 방법

#### Step 1: 분양가DB 시트에 IMPORTRANGE 설정

**매물관리 시트의 새 시트 생성**: `분양가DB_임포트`

```excel
=IMPORTRANGE("정규화_스프레드시트_URL", "분양가!A:G")
```

**열 구조** (예시):
```
A: 단지명
B: 동
C: 호
D: 타입
E: 최저층
F: 최고층
G: 분양가
```

#### Step 2: 등록검색 시트에 자동 조회 수식

**C10 셀 (분양가 자동 입력)**:
```excel
=IFERROR(
  INDEX(
    분양가DB_임포트!G:G,
    MATCH(
      1,
      (분양가DB_임포트!A:A=C4) *
      (분양가DB_임포트!B:B=C5) *
      (분양가DB_임포트!C:C=C6),
      0
    )
  ),
  ""
)
```

**설명**:
- `C4`: 단지명
- `C5`: 동
- `C6`: 호
- 3개 조건이 모두 일치하는 행의 분양가(G열) 반환

#### Step 3: 발코니/옵션비 자동 입력

**C11 셀 (발코니 확장비)**:
```excel
=IFERROR(
  VLOOKUP(
    C4&"-"&C7,
    IMPORTRANGE("정규화_스프레드시트_URL", "옵션!A:C"),
    3,
    FALSE
  ),
  ""
)
```

**조건**:
- `C4`: 단지명
- `C7`: 타입
- 옵션 시트 구조: `단지명-타입 | 옵션명 | 금액`

---

## 📋 방법 2: Apps Script 자동화

### 장점
- ✅ 복잡한 로직 처리 가능
- ✅ 여러 시트/파일 동시 조회
- ✅ 에러 핸들링 가능

### 단점
- ⚠️ 코드 작성 필요
- ⚠️ 실행 시간 제한 (6분)

### 구현 코드

```javascript
/**
 * 정규화된 분양가 데이터를 자동으로 가져오는 함수
 */
function loadPricingData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const regSheet = ss.getSheetByName('등록검색');

  // 입력된 값 읽기
  const apartmentName = regSheet.getRange('C4').getValue(); // 단지명
  const dong = regSheet.getRange('C5').getValue();           // 동
  const ho = regSheet.getRange('C6').getValue();             // 호
  const type = regSheet.getRange('C7').getValue();           // 타입

  if (!apartmentName || !dong || !ho) {
    return; // 필수 값 없으면 종료
  }

  // 정규화 데이터 스프레드시트 연결
  const normalizedSheetId = 'YOUR_NORMALIZED_SHEET_ID'; // 실제 ID로 교체
  const normalizedSs = SpreadsheetApp.openById(normalizedSheetId);

  // 분양가 조회
  const pricingData = getPricingFromNormalizedData(
    normalizedSs,
    apartmentName,
    dong,
    ho
  );

  if (pricingData) {
    // 분양가 자동 입력
    regSheet.getRange('C10').setValue(pricingData.supplyPrice);

    // 타입 자동 입력 (분양가 데이터에서 추출)
    if (pricingData.type) {
      regSheet.getRange('C7').setValue(pricingData.type);
    }
  }

  // 옵션 데이터 조회 (타입 기준)
  if (type) {
    const optionData = getOptionsFromNormalizedData(
      normalizedSs,
      apartmentName,
      type
    );

    if (optionData) {
      // 발코니 확장비
      if (optionData.balcony) {
        regSheet.getRange('C11').setValue(optionData.balcony);
      }

      // 기본 옵션비
      if (optionData.basicOption) {
        regSheet.getRange('C12').setValue(optionData.basicOption);
      }
    }
  }
}

/**
 * 정규화된 분양가 데이터에서 조회
 */
function getPricingFromNormalizedData(ss, apartmentName, dong, ho) {
  const pricingSheet = ss.getSheetByName('분양가');
  const data = pricingSheet.getDataRange().getValues();

  // 헤더 제외하고 검색
  for (let i = 1; i < data.length; i++) {
    const row = data[i];

    // 열 인덱스 (실제 구조에 맞게 조정)
    const rowApartment = row[0]; // A열: 단지명
    const rowDong = row[1];      // B열: 동
    const rowHo = row[2];        // C열: 호
    const rowType = row[3];      // D열: 타입
    const rowPrice = row[6];     // G열: 분양가

    // 조건 매칭
    if (rowApartment === apartmentName &&
        rowDong == dong &&
        rowHo == ho) {
      return {
        type: rowType,
        supplyPrice: rowPrice
      };
    }
  }

  return null; // 매칭되는 데이터 없음
}

/**
 * 정규화된 옵션 데이터에서 조회
 */
function getOptionsFromNormalizedData(ss, apartmentName, type) {
  const optionSheet = ss.getSheetByName('옵션');
  const data = optionSheet.getDataRange().getValues();

  let balcony = null;
  let basicOption = null;

  for (let i = 1; i < data.length; i++) {
    const row = data[i];

    const rowApartment = row[0]; // A열: 단지명
    const optionType = row[1];   // B열: 옵션구분
    const rowType = row[2];      // C열: 타입
    const amount = row[6];       // G열: 공급금액

    if (rowApartment === apartmentName && rowType === type) {
      // 발코니 확장
      if (optionType === '발코니 확장') {
        balcony = amount;
      }

      // 기본 옵션 (필요시 조건 추가)
      if (optionType === '시스템에어컨') {
        basicOption = amount;
      }
    }
  }

  return {
    balcony: balcony,
    basicOption: basicOption
  };
}

/**
 * 단지명, 동, 호 입력 시 자동 실행 (onEdit 트리거)
 */
function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  const range = e.range;

  // 등록검색 시트의 C4, C5, C6 셀 수정 시에만 실행
  if (sheet.getName() === '등록검색') {
    const row = range.getRow();
    const col = range.getColumn();

    // C열(3열)의 4~6행 (단지명, 동, 호)
    if (col === 3 && row >= 4 && row <= 6) {
      // 0.5초 딜레이 후 실행 (사용자 입력 완료 대기)
      Utilities.sleep(500);
      loadPricingData();
    }
  }
}
```

---

## 📋 방법 3: n8n 워크플로우 (고급)

### 장점
- ✅ 외부 API와 연동 가능
- ✅ 복잡한 비즈니스 로직 처리
- ✅ 다른 시스템과 통합 가능

### 단점
- ⚠️ n8n 서버 필요
- ⚠️ 복잡도 높음

### 워크플로우 구조

```
Google Sheets Trigger (등록검색 시트 변경 감지)
    ↓
동/호 값 읽기
    ↓
정규화 데이터 시트 조회 (Google Sheets 노드)
    ↓
데이터 매칭 및 변환
    ↓
등록검색 시트 업데이트 (분양가, 옵션비 입력)
```

---

## 🎯 권장 구현 순서

### Phase 1: IMPORTRANGE 기본 연동
1. ✅ 분양가DB_임포트 시트 생성
2. ✅ IMPORTRANGE로 정규화 데이터 가져오기
3. ✅ VLOOKUP/INDEX-MATCH로 자동 조회

### Phase 2: Apps Script 자동화
1. ✅ `loadPricingData()` 함수 구현
2. ✅ `onEdit()` 트리거 설정
3. ✅ 에러 핸들링 추가

### Phase 3: n8n 고급 자동화
1. ⏳ Google Sheets Trigger 설정
2. ⏳ 데이터 변환 로직 구현
3. ⏳ 알림 및 검증 로직 추가

---

## 📝 실제 구현 예시

### 정규화 스프레드시트 구조

**분양가 시트**:
```
| 단지명 | 동 | 호 | 타입 | 최저층 | 최고층 | 분양가 |
|--------|----|----|------|--------|--------|--------|
| 이성호 | 102 | 503 | 84A | 5 | 5 | 51000 |
| 이성호 | 102 | 504 | 84A | 5 | 5 | 51000 |
```

**옵션 시트**:
```
| 단지명 | 옵션구분 | 타입 | 품목 | 품목세부 | 설치내역 | 공급금액 |
|--------|----------|------|------|----------|----------|----------|
| 이성호 | 발코니 확장 | 84A | 발코니 | - | 전체 | 1400 |
| 이성호 | 시스템에어컨 | 84A | 가전 | 전체 | 5대 | 680 |
```

### 등록검색 시트 수식

**C10 (분양가)**:
```excel
=IFERROR(
  INDEX(
    분양가DB_임포트!G:G,
    MATCH(
      C4&C5&C6,
      분양가DB_임포트!A:A&분양가DB_임포트!B:B&분양가DB_임포트!C:C,
      0
    )
  ),
  ""
)
```

**C11 (발코니)**:
```excel
=IFERROR(
  SUMIFS(
    옵션DB_임포트!G:G,
    옵션DB_임포트!A:A, C4,
    옵션DB_임포트!B:B, "발코니 확장",
    옵션DB_임포트!C:C, C7
  ),
  ""
)
```

---

## ⚙️ 설정 가이드

### 1. 정규화 스프레드시트 ID 확인

1. 정규화 데이터가 저장된 스프레드시트 열기
2. URL에서 ID 복사:
   ```
   https://docs.google.com/spreadsheets/d/[이부분이ID]/edit
   ```

### 2. IMPORTRANGE 권한 설정

1. 매물관리 시트에 수식 입력:
   ```excel
   =IMPORTRANGE("정규화_스프레드시트_ID", "분양가!A:G")
   ```
2. `#REF!` 에러 클릭 → "액세스 허용" 클릭

### 3. Apps Script 배포

1. 확장 프로그램 → Apps Script
2. 위 코드 복사 붙여넣기
3. `YOUR_NORMALIZED_SHEET_ID` 부분을 실제 ID로 교체
4. 저장 → 실행 → 권한 승인

---

## 🚀 다음 단계

어떤 방법으로 구현하시겠어요?

1. **IMPORTRANGE + 수식** (빠르고 간단)
2. **Apps Script** (유연하고 강력)
3. **n8n 워크플로우** (고급 자동화)

선택하시면 바로 구현 도와드리겠습니다! 🎉
