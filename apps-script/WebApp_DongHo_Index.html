<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
    }

    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 8px;
      font-size: 24px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 32px;
      font-size: 14px;
    }

    .contact-info {
      text-align: center;
      margin-bottom: 24px;
      font-size: 14px;
      color: #666;
    }

    .contact-info a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    label .required {
      color: #e74c3c;
    }

    select, input, textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    select {
      cursor: pointer;
      background: white;
    }

    .type-display {
      background: #f8f9fa;
      padding: 14px;
      border-radius: 8px;
      color: #666;
      font-size: 14px;
    }

    /* ê±°ë˜ìœ í˜• ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .checkbox-item {
      flex: 1;
      min-width: 80px;
    }

    .checkbox-item input[type="checkbox"] {
      display: none;
    }

    .checkbox-item label {
      display: block;
      padding: 12px 16px;
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .checkbox-item input[type="checkbox"]:checked + label {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }

    /* ì¡°ê±´ë¶€ ê°€ê²© í•„ë“œ */
    .price-fields {
      margin-top: 12px;
    }

    .price-field {
      display: none;
      margin-bottom: 12px;
      padding: 16px;
      background: #fafafa;
      border-radius: 8px;
      animation: slideDown 0.3s ease;
    }

    .price-field.active {
      display: block;
    }

    .price-field label {
      font-size: 14px;
      color: #666;
      margin-bottom: 6px;
    }

    .price-field input {
      background: white;
    }

    .rent-row {
      display: flex;
      gap: 10px;
    }

    .rent-row > div {
      flex: 1;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* íŒŒì¼ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
    .file-upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }

    .file-upload-area:hover,
    .file-upload-area.dragover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .file-upload-area .icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .file-upload-area p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }

    .file-upload-area .hint {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
    }

    #fileInput {
      display: none;
    }

    /* íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° */
    .file-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    .file-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .file-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .file-preview-item .file-icon {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      font-size: 24px;
    }

    .file-preview-item .file-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 10px;
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-preview-item .remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: rgba(255,0,0,0.8);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ë²„íŠ¼ */
    button[type="submit"] {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    button[type="submit"]:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .success-message {
      text-align: center;
      padding: 40px;
    }

    .success-message h2 {
      color: #27ae60;
      margin-bottom: 16px;
    }

    .success-message p {
      color: #666;
    }

    .error-message {
      background: #fee;
      color: #c00;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    /* ì§„í–‰ ìƒíƒœ í‘œì‹œ */
    .progress-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .progress-overlay.active {
      display: flex;
    }

    .progress-box {
      background: white;
      padding: 30px 40px;
      border-radius: 16px;
      text-align: center;
    }

    .progress-box .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¢ ìš°ë°©ì•„ì´ìœ ì‰˜ ë§¤ë¬¼ì ‘ìˆ˜</h1>
    <p class="subtitle">ë°°ë°© 2ë‹¨ì§€</p>

    <div class="contact-info">
      ì „í™”ë¡œ ì£¼ì…”ë„ ë©ë‹ˆë‹¤!!! (ëˆ„ë¥´ë©´ ì „í™”ì—°ê²°)<br>
      <a href="tel:010-8282-8684">010-8282-8684</a> Â·
      <a href="tel:010-6587-4949">010-6587-4949</a>
    </div>

    <div id="loading" class="loading">
      ë°ì´í„° ë¡œë”© ì¤‘...
    </div>

    <form id="mainForm" style="display: none;">
      <!-- ë™ ì„ íƒ -->
      <div class="form-group">
        <label>ë™ <span class="required">*</span></label>
        <select id="dongSelect" required>
          <option value="">ëª‡ ë™</option>
        </select>
      </div>

      <!-- í˜¸ ì„ íƒ -->
      <div class="form-group">
        <label>í˜¸ <span class="required">*</span></label>
        <select id="hoSelect" required disabled>
          <option value="">ëª‡ í˜¸</option>
        </select>
      </div>

      <!-- íƒ€ì… í‘œì‹œ -->
      <div class="form-group">
        <label>íƒ€ì…</label>
        <div id="typeDisplay" class="type-display">ë™/í˜¸ ì„ íƒ ì‹œ ìë™ í‘œì‹œ</div>
      </div>

      <!-- ì—°ë½ì²˜ -->
      <div class="form-group">
        <label>ì—°ë½ì²˜ <span class="required">*</span></label>
        <input type="tel" id="phoneInput" placeholder="010-0000-0000" required>
      </div>

      <!-- ê±°ë˜ìœ í˜• (ë³µìˆ˜ì„ íƒ) -->
      <div class="form-group">
        <label>ê±°ë˜ìœ í˜• <span class="required">*</span></label>
        <p style="font-size:12px; color:#888; margin:0 0 10px 0;">ë§¤ë§¤, ì „ì„¸, ì›”ì„¸ ë™ì‹œ ì§„í–‰ ì‹œ ì¤‘ë³µì„ íƒ ê°€ëŠ¥</p>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="typeSale" value="ë§¤ë§¤">
            <label for="typeSale">ë§¤ë§¤</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="typeJeonse" value="ì „ì„¸">
            <label for="typeJeonse">ì „ì„¸</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="typeRent" value="ì›”ì„¸">
            <label for="typeRent">ì›”ì„¸</label>
          </div>
        </div>

        <!-- ì¡°ê±´ë¶€ ê°€ê²© í•„ë“œ -->
        <div class="price-fields">
          <div id="salePriceField" class="price-field">
            <label>ë§¤ë§¤ê°€</label>
            <input type="text" id="salePrice" placeholder="ë§¤ë§¤ì¼ ê²½ìš° ë§¤ë§¤ê°€(3ì–µ 8ì²œ)">
          </div>
          <div id="jeonsePriceField" class="price-field">
            <label>ì „ì„¸ê°€</label>
            <input type="text" id="jeonsePrice" placeholder="ì „ì„¸ì¼ ê²½ìš° ì „ì„¸ê°€(3ì–µ 8ì²œ)">
          </div>
          <div id="rentPriceField" class="price-field">
            <label>ì›”ì„¸</label>
            <div class="rent-row">
              <div>
                <input type="text" id="deposit" placeholder="ë³´ì¦ê¸ˆ(2000)">
              </div>
              <div>
                <input type="text" id="monthlyRent" placeholder="ì›”(100)">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì°¸ê³ ì‚¬í•­ -->
      <div class="form-group">
        <label>ì°¸ê³ ì‚¬í•­</label>
        <textarea id="memoInput" rows="4" placeholder="ì˜µì…˜, ì…ì£¼ê°€ëŠ¥ì¼, ì´ì‚¬ê³„íš, ê°€ê²©ì¡°ì ˆ ì—¬ë¶€, í¬ë§ì‚¬í•­ ë“±ë“± ì•„ë¬´ê±°ë‚˜"></textarea>
      </div>

      <!-- íŒŒì¼ ì—…ë¡œë“œ -->
      <div class="form-group">
        <label>ì‚¬ì§„ ì´ë‚˜ ë™ì˜ìƒ</label>
        <p style="font-size:12px; color:#667eea; margin:0 0 10px 0;">ê´‘ê³ , ë¸”ë¡œê·¸, ìœ íŠœë¸Œ ë“±ë“± ì°¸ê³ í•´ì„œ ìµœëŒ€í•œ ë¹¨ë¦¬ ë¹¼ë“œë¦½ë‹ˆë‹¤</p>
        <div class="file-upload-area" id="dropZone">
          <div class="icon">ğŸ“</div>
          <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
          <p class="hint">ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ê°€ëŠ¥</p>
        </div>
        <input type="file" id="fileInput" multiple>
        <div class="file-preview-container" id="filePreview"></div>
      </div>

      <div id="errorMsg" class="error-message" style="display: none;"></div>

      <button type="submit" id="submitBtn">ì ‘ìˆ˜ â†’</button>
    </form>

    <div id="successMessage" class="success-message" style="display: none;">
      <h2>âœ… ì ‘ìˆ˜ ì™„ë£Œ!</h2>
      <p>ë§¤ë¬¼ ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>
      <button onclick="location.reload()" style="margin-top:20px; padding:12px 24px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer;">ìƒˆë¡œìš´ ì ‘ìˆ˜í•˜ê¸°</button>
    </div>
  </div>

  <!-- ì§„í–‰ ìƒíƒœ ì˜¤ë²„ë ˆì´ -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-box">
      <div class="spinner"></div>
      <p id="progressText">ì ‘ìˆ˜ ì¤‘...</p>
    </div>
  </div>

  <script>
    let dongHoData = {};
    let selectedFiles = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
      google.script.run
        .withSuccessHandler(onDataLoaded)
        .withFailureHandler(onError)
        .getDongHoData();

      initFileUpload();
      initTransactionTypeHandlers();
    });

    // ë°ì´í„° ë¡œë“œ ì™„ë£Œ
    function onDataLoaded(data) {
      dongHoData = data;

      const dongSelect = document.getElementById('dongSelect');
      data.dongList.forEach(dong => {
        const option = document.createElement('option');
        option.value = dong;
        option.textContent = dong + 'ë™';
        dongSelect.appendChild(option);
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('mainForm').style.display = 'block';
    }

    // ë™ ì„ íƒ ë³€ê²½
    document.getElementById('dongSelect').addEventListener('change', function() {
      const dong = this.value;
      const hoSelect = document.getElementById('hoSelect');
      const typeDisplay = document.getElementById('typeDisplay');

      hoSelect.innerHTML = '';

      if (!dong) {
        hoSelect.disabled = true;
        hoSelect.innerHTML = '<option value="">ëª‡ í˜¸</option>';
        typeDisplay.textContent = 'ë™/í˜¸ ì„ íƒ ì‹œ ìë™ í‘œì‹œ';
        return;
      }

      hoSelect.disabled = false;
      hoSelect.innerHTML = '<option value="">ëª‡ í˜¸</option>';

      const hoList = dongHoData.dongHoMap[dong] || [];
      hoList.forEach(item => {
        const option = document.createElement('option');
        option.value = item.ho;
        option.dataset.type = item.type;
        option.textContent = item.ho + 'í˜¸ (' + item.type + ')';
        hoSelect.appendChild(option);
      });

      typeDisplay.textContent = 'í˜¸ë¥¼ ì„ íƒí•˜ë©´ íƒ€ì…ì´ í‘œì‹œë©ë‹ˆë‹¤';
    });

    // í˜¸ ì„ íƒ ë³€ê²½
    document.getElementById('hoSelect').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const typeDisplay = document.getElementById('typeDisplay');

      if (selectedOption && selectedOption.dataset.type) {
        typeDisplay.textContent = 'íƒ€ì…: ' + selectedOption.dataset.type;
      } else {
        typeDisplay.textContent = 'í˜¸ë¥¼ ì„ íƒí•˜ë©´ íƒ€ì…ì´ í‘œì‹œë©ë‹ˆë‹¤';
      }
    });

    // ê±°ë˜ìœ í˜• ì²´í¬ë°•ìŠ¤ í•¸ë“¤ëŸ¬
    function initTransactionTypeHandlers() {
      const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.addEventListener('change', updatePriceFields);
      });
    }

    function updatePriceFields() {
      const salePriceField = document.getElementById('salePriceField');
      const jeonsePriceField = document.getElementById('jeonsePriceField');
      const rentPriceField = document.getElementById('rentPriceField');

      salePriceField.classList.toggle('active', document.getElementById('typeSale').checked);
      jeonsePriceField.classList.toggle('active', document.getElementById('typeJeonse').checked);
      rentPriceField.classList.toggle('active', document.getElementById('typeRent').checked);
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
    function initFileUpload() {
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');

      // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
      dropZone.addEventListener('click', () => fileInput.click());

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });

      // íŒŒì¼ ì„ íƒ
      fileInput.addEventListener('change', () => {
        handleFiles(fileInput.files);
      });
    }

    // íŒŒì¼ ì²˜ë¦¬
    function handleFiles(files) {
      Array.from(files).forEach(file => {
        // ì¤‘ë³µ ì²´í¬
        if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
          return;
        }
        selectedFiles.push(file);
      });
      updateFilePreview();
    }

    // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    function updateFilePreview() {
      const preview = document.getElementById('filePreview');
      preview.innerHTML = '';

      selectedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'file-preview-item';

        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          item.appendChild(img);
        } else {
          const icon = document.createElement('div');
          icon.className = 'file-icon';
          icon.textContent = getFileIcon(file.type);
          item.appendChild(icon);
        }

        const nameDiv = document.createElement('div');
        nameDiv.className = 'file-name';
        nameDiv.textContent = file.name;
        item.appendChild(nameDiv);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = 'Ã—';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          selectedFiles.splice(index, 1);
          updateFilePreview();
        };
        item.appendChild(removeBtn);

        preview.appendChild(item);
      });
    }

    function getFileIcon(mimeType) {
      if (mimeType.includes('pdf')) return 'ğŸ“„';
      if (mimeType.includes('video')) return 'ğŸ¬';
      if (mimeType.includes('audio')) return 'ğŸµ';
      return 'ğŸ“';
    }

    // íŒŒì¼ì„ base64ë¡œ ë³€í™˜
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve({
            name: file.name,
            mimeType: file.type,
            data: base64
          });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // í¼ ì œì¶œ
    document.getElementById('mainForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // ê±°ë˜ìœ í˜• ì²´í¬ í™•ì¸
      const transactionTypes = [];
      if (document.getElementById('typeSale').checked) transactionTypes.push('ë§¤ë§¤');
      if (document.getElementById('typeJeonse').checked) transactionTypes.push('ì „ì„¸');
      if (document.getElementById('typeRent').checked) transactionTypes.push('ì›”ì„¸');

      if (transactionTypes.length === 0) {
        showError('ê±°ë˜ìœ í˜•ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      const progressOverlay = document.getElementById('progressOverlay');
      const progressText = document.getElementById('progressText');

      submitBtn.disabled = true;
      progressOverlay.classList.add('active');
      hideError();

      try {
        // íŒŒì¼ ë³€í™˜
        progressText.textContent = 'íŒŒì¼ ì²˜ë¦¬ ì¤‘...';
        const fileData = await Promise.all(selectedFiles.map(fileToBase64));

        const hoSelect = document.getElementById('hoSelect');
        const selectedOption = hoSelect.options[hoSelect.selectedIndex];

        const formData = {
          dong: document.getElementById('dongSelect').value,
          ho: document.getElementById('hoSelect').value,
          type: selectedOption ? selectedOption.dataset.type : '',
          phone: document.getElementById('phoneInput').value,
          transactionTypes: transactionTypes,
          salePrice: document.getElementById('salePrice').value,
          jeonsePrice: document.getElementById('jeonsePrice').value,
          deposit: document.getElementById('deposit').value,
          monthlyRent: document.getElementById('monthlyRent').value,
          memo: document.getElementById('memoInput').value,
          files: fileData
        };

        progressText.textContent = 'ì„œë²„ë¡œ ì „ì†¡ ì¤‘...';

        google.script.run
          .withSuccessHandler(onSubmitSuccess)
          .withFailureHandler(onSubmitError)
          .submitForm(formData);

      } catch (error) {
        onSubmitError(error);
      }
    });

    function onSubmitSuccess(result) {
      const progressOverlay = document.getElementById('progressOverlay');
      progressOverlay.classList.remove('active');

      if (result.success) {
        document.getElementById('mainForm').style.display = 'none';
        document.getElementById('successMessage').style.display = 'block';
      } else {
        onSubmitError(result.message);
      }
    }

    function onSubmitError(error) {
      const submitBtn = document.getElementById('submitBtn');
      const progressOverlay = document.getElementById('progressOverlay');

      progressOverlay.classList.remove('active');
      submitBtn.disabled = false;
      showError(typeof error === 'string' ? error : error.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }

    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorMsg').style.display = 'none';
    }

    function onError(error) {
      document.getElementById('loading').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error;
    }
  </script>
</body>
</html>
