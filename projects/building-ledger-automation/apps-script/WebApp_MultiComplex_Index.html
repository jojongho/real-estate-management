<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¶€ë™ì‚° í†µí•© ë§¤ë¬¼ì ‘ìˆ˜</title>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --accent-color: #00c6ff;
      --text-dark: #2d3436;
      --bg-light: #f1f2f6;
    }

    * { box-sizing: border-box; font-family: 'Pretendard', -apple-system, sans-serif; }

    body {
      margin: 0; padding: 20px;
      background: var(--bg-light);
      color: var(--text-dark);
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh;
    }

    .card {
      width: 100%; max-width: 550px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    h1 { margin: 0 0 10px; font-size: 26px; text-align: center; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 14px; }

    .step-container { margin-bottom: 25px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 15px; color: #34495e; }
    
    select, input, textarea {
      width: 100%; padding: 15px; border: 2px solid #edf2f7; border-radius: 12px;
      font-size: 16px; transition: all 0.3s ease; background: #fff;
    }

    select:focus, input:focus, textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 4px rgba(0, 198, 255, 0.1); }

    .price-info-box {
      background: #f8f9fa; border-left: 5px solid var(--accent-color);
      padding: 20px; border-radius: 12px; margin: 20px 0; display: none;
    }

    .price-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 15px; }
    .price-val { font-weight: 700; color: #2c3e50; }

    .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
    .option-item {
      display: flex; align-items: center; padding: 12px;
      background: #fff; border: 1px solid #eee; border-radius: 10px; cursor: pointer;
      transition: background 0.2s;
    }
    .option-item:hover { background: #f1f9ff; }
    .option-item input { width: auto; margin-right: 12px; cursor: pointer; }

    .total-section {
      margin-top: 30px; padding: 25px;
      background: #2d3436; color: #fff; border-radius: 15px;
      text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .total-label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; }
    .total-amount { font-size: 28px; font-weight: 800; color: #00f2fe; }

    button {
      width: 100%; padding: 18px; margin-top: 25px;
      border: none; border-radius: 12px;
      background: var(--primary-gradient); color: white;
      font-size: 18px; font-weight: 700; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 198, 255, 0.3); }
    button:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; }

    .loader { text-align: center; padding: 20px; color: var(--accent-color); font-weight: 600; }
    
    /* ì„±ê³µ í™”ë©´ */
    #successUI { display: none; text-align: center; padding: 20px; }
    .success-icon { font-size: 60px; color: #2ecc71; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="card">
  <div id="formUI">
    <h1>ğŸ¬ í†µí•© ë§¤ë¬¼ì ‘ìˆ˜ & ê²¬ì </h1>
    <p class="subtitle">ë‹¨ì§€ë³„ ë¶„ì–‘ê°€ ë° ì˜µì…˜ ì‹¤ì‹œê°„ ì‚°ì¶œ</p>

    <!-- 1ë‹¨ê³„: ë‹¨ì§€/ë™/í˜¸ ì„ íƒ -->
    <div class="step-container">
      <label>ì•„íŒŒíŠ¸ ë‹¨ì§€ ì„ íƒ</label>
      <select id="complexSelect" onchange="loadDongs()">
        <option value="">ë‹¨ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>

    <div class="step-container">
      <label>ë™ ì„ íƒ</label>
      <select id="dongSelect" onchange="loadHos()" disabled>
        <option value="">ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>

    <div class="step-container">
      <label>í˜¸ìˆ˜ ì„ íƒ</label>
      <select id="hoSelect" onchange="loadDetails()" disabled>
        <option value="">í˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>

    <!-- ë¡œë”© í‘œì‹œ -->
    <div id="miniLoader" class="loader" style="display:none;">ë°ì´í„° ì¡°íšŒ ì¤‘...</div>

    <!-- 2ë‹¨ê³„: ìë™ ì‚°ì¶œ ì •ë³´ í‘œì‹œ -->
    <div id="priceInfoBox" class="price-info-box">
      <div class="price-row"><span>ë‹¨ì§€/íƒ€ì…:</span> <span id="typeDisplay" class="price-val">-</span></div>
      <div class="price-row"><span>ê¸°ë³¸ ë¶„ì–‘ê°€:</span> <span id="basePriceDisplay" class="price-val">0</span> ì›</div>
      <div class="price-row"><span>ë°œì½”ë‹ˆ í™•ì¥ë¹„:</span> <span id="balconyPriceDisplay" class="price-val">0</span> ì›</div>
      
      <label style="margin-top:20px;">ë¬´ìƒ/ìœ ìƒ ì˜µì…˜ ì„ íƒ</label>
      <div id="optionsGrid" class="options-grid">
        <!-- ì˜µì…˜ë“¤ ë™ì  ìƒì„± -->
      </div>
    </div>

    <!-- 3ë‹¨ê³„: ì´ì•¡ ë° ì—°ë½ì²˜ -->
    <div id="finalSection" style="display:none;">
      <div class="total-section">
        <div class="total-label">ì˜ˆìƒ ì´ ê³µê¸‰ê°€ì•¡ (ë¶„ì–‘ê°€+ë°œì½”ë‹ˆ+ì˜µì…˜)</div>
        <div id="totalAmount" class="total-amount">0</div>
      </div>

      <div class="step-container" style="margin-top:25px;">
        <label>ì´ë¦„ <span style="color:red">*</span></label>
        <input type="text" id="userName" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”" required>
      </div>

      <div class="step-container">
        <label>ì—°ë½ì²˜ <span style="color:red">*</span></label>
        <input type="tel" id="userPhone" placeholder="010-0000-0000" required>
      </div>

      <div class="step-container">
        <label>ë©”ëª¨</label>
        <textarea id="userMemo" rows="3" placeholder="ì¶”ê°€ ë¬¸ì˜ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>

      <button id="submitBtn" onclick="submitForm()">ì ‘ìˆ˜ ë° ê²¬ì  ì €ì¥í•˜ê¸°</button>
    </div>
  </div>

  <div id="successUI">
    <div class="success-icon">âœ…</div>
    <h2>ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
    <p>ë‹´ë‹¹ìê°€ í™•ì¸ í›„ ê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>
    <button onclick="location.reload()">ìƒˆë¡œ ì‘ì„±í•˜ê¸°</button>
  </div>
</div>

<script>
  let currentUnitDetail = null;

  // ì´ˆê¸°ì— ë‹¨ì§€ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
  window.onload = () => {
    google.script.run.withSuccessHandler(list => {
      const sel = document.getElementById('complexSelect');
      list.forEach(name => sel.add(new Option(name, name)));
    }).getComplexList();
  };

  function loadDongs() {
    const complex = document.getElementById('complexSelect').value;
    const dongSel = document.getElementById('dongSelect');
    resetNextSteps('dong');
    if(!complex) return;

    showLoader(true);
    google.script.run.withSuccessHandler(list => {
      list.forEach(d => dongSel.add(new Option(d + 'ë™', d)));
      dongSel.disabled = false;
      showLoader(false);
    }).getDongList(complex);
  }

  function loadHos() {
    const complex = document.getElementById('complexSelect').value;
    const dong = document.getElementById('dongSelect').value;
    const hoSel = document.getElementById('hoSelect');
    resetNextSteps('ho');
    if(!dong) return;

    showLoader(true);
    google.script.run.withSuccessHandler(list => {
      list.forEach(h => hoSel.add(new Option(h + 'í˜¸', h)));
      hoSel.disabled = false;
      showLoader(false);
    }).getHoList(complex, dong);
  }

  function loadDetails() {
    const complex = document.getElementById('complexSelect').value;
    const dong = document.getElementById('dongSelect').value;
    const ho = document.getElementById('hoSelect').value;
    if(!ho) return;

    showLoader(true);
    google.script.run.withSuccessHandler(res => {
      if(res.success) {
        currentUnitDetail = res;
        displayDetails(res);
      } else {
        alert(res.message);
      }
      showLoader(false);
    }).getUnitDetails(complex, dong, ho);
  }

  function displayDetails(res) {
    document.getElementById('priceInfoBox').style.display = 'block';
    document.getElementById('finalSection').style.display = 'block';
    
    document.getElementById('typeDisplay').innerText = res.unitInfo.type;
    document.getElementById('basePriceDisplay').innerText = Number(res.unitInfo.basePrice).toLocaleString();
    document.getElementById('balconyPriceDisplay').innerText = Number(res.unitInfo.balconyPrice).toLocaleString();
    
    const grid = document.getElementById('optionsGrid');
    grid.innerHTML = '';
    
    res.options.forEach((opt, idx) => {
      const div = document.createElement('div');
      div.className = 'option-item';
      div.innerHTML = `
        <input type="checkbox" id="opt_${idx}" value="${opt.price}" onchange="calculateTotal()">
        <label for="opt_${idx}" style="margin:0; cursor:pointer;">
          ${opt.name} (${opt.detail}) - <strong>${Number(opt.price).toLocaleString()}ì›</strong>
        </label>
      `;
      grid.appendChild(div);
    });
    
    calculateTotal();
  }

  function calculateTotal() {
    if(!currentUnitDetail) return;
    
    let total = Number(currentUnitDetail.unitInfo.basePrice) + Number(currentUnitDetail.unitInfo.balconyPrice);
    
    const checkboxes = document.querySelectorAll('#optionsGrid input[type="checkbox"]:checked');
    checkboxes.forEach(cb => {
      total += Number(cb.value);
    });
    
    document.getElementById('totalAmount').innerText = total.toLocaleString() + ' ì›';
  }

  function submitForm() {
    const btn = document.getElementById('submitBtn');
    const name = document.getElementById('userName').value;
    const phone = document.getElementById('userPhone').value;
    
    if(!name || !phone) { alert('ì´ë¦„ê³¼ ì—°ë½ì²˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
    
    btn.disabled = true;
    btn.innerText = 'ì ‘ìˆ˜ ì¤‘...';

    const selectedOptions = Array.from(document.querySelectorAll('#optionsGrid input[type="checkbox"]:checked'))
      .map(cb => cb.parentElement.innerText.trim());

    const formData = {
      complex: document.getElementById('complexSelect').value,
      dong: document.getElementById('dongSelect').value,
      ho: document.getElementById('hoSelect').value,
      type: currentUnitDetail.unitInfo.type,
      basePrice: currentUnitDetail.unitInfo.basePrice,
      balconyPrice: currentUnitDetail.unitInfo.balconyPrice,
      selectedOptionsText: selectedOptions.join(' / '),
      totalAmount: document.getElementById('totalAmount').innerText,
      name: name,
      phone: phone,
      memo: document.getElementById('userMemo').value
    };

    google.script.run.withSuccessHandler(res => {
      if(res.success) {
        document.getElementById('formUI').style.display = 'none';
        document.getElementById('successUI').style.display = 'block';
      } else {
        alert(res.message);
        btn.disabled = false;
        btn.innerText = 'ì ‘ìˆ˜ ë° ê²¬ì  ì €ì¥í•˜ê¸°';
      }
    }).submitForm(formData);
  }

  function resetNextSteps(stage) {
    if(stage === 'dong') {
      document.getElementById('dongSelect').innerHTML = '<option value="">ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      document.getElementById('dongSelect').disabled = true;
    }
    document.getElementById('hoSelect').innerHTML = '<option value="">í˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    document.getElementById('hoSelect').disabled = true;
    document.getElementById('priceInfoBox').style.display = 'none';
    document.getElementById('finalSection').style.display = 'none';
  }

  function showLoader(show) {
    document.getElementById('miniLoader').style.display = show ? 'block' : 'none';
  }
</script>

</body>
</html>
