# 작업 로그: 옵션 데이터 처리 개선

**날짜**: 2025-10-05
**작업자**: Claude Code
**프로젝트**: apartment-automation

---

## 📋 작업 요약

PDF 추출 시스템과 Google Sheets 옵션 처리 로직을 개선하여 데이터 중복을 제거하고 효율성을 향상시켰습니다.

---

## ✅ 완료된 작업

### 1️⃣ 발코니 데이터 처리 방식 변경

**변경 전**:
- PDF 추출 시 발코니 정보를 별도 CSV 파일로 저장
- 5단계 추출: 분양가 → 옵션 → 단지일정 → 타입정보 → 발코니

**변경 후**:
- 발코니를 옵션 CSV에 통합 (`옵션구분: "발코니확장"`)
- 4단계 추출: 분양가 → 옵션(발코니 포함) → 단지일정 → 타입정보
- 앱스스크립트에서 발코니 제외 후 C11 수식으로 별도 조회

**이유**:
- 발코니 확장은 한국 아파트 분양 시장에서 거의 100% 선택하는 필수 옵션
- 선택 옵션 목록에서 제외하고 무조건 포함시키는 것이 더 효율적

**관련 파일**:
- `src/collectors/pdf_to_data.py`: `_extract_balcony()` 메서드 제거
- `apps-script/통합_최종_스크립트_v2_개선.js`: 발코니 필터링 추가

---

### 2️⃣ 옵션 타입 매칭 로직 개선

**변경 전**:
```javascript
var filteredData = optionsData.filter(row =>
  row[0] === apartmentName &&
  row[2] === typeValue  // 정확히 일치해야만 매칭
);
```

**변경 후**:
```javascript
var filteredData = optionsData.filter(row => {
  var rowApartment = row[0];   // A열: 단지명
  var rowCategory = row[1];    // B열: 옵션구분
  var rowType = row[2];         // C열: 타입

  // 단지명 매칭
  if (rowApartment !== apartmentName) return false;

  // 발코니확장 제외
  if (rowCategory === "발코니확장") return false;

  // "전체" 타입 자동 포함
  if (rowType === "전체") return true;

  // "84A,84B" 형태의 타입 문자열 처리
  var typeList = rowType.toString().split(',').map(function(t) { return t.trim(); });
  return typeList.indexOf(typeValue) !== -1;
});
```

**개선 사항**:
1. **전체 옵션 자동 적용**: `타입: "전체"` → 모든 타입에 적용
2. **복수 타입 처리**: `타입: "84A,84B"` → 쉼표로 분리하여 매칭
3. **발코니 제외**: 옵션구분이 "발코니확장"인 항목 자동 제외
4. **데이터 중복 제거**: CSV에 중복 저장 없이 하나의 레코드로 관리

**예시**:
```csv
# CSV 데이터
단지명,옵션구분,타입,공급금액
아산모종,빌트인,"84A,84B",880000
아산모종,가전,"전체",800000
아산모종,발코니확장,"84A",10000000

# 84A 타입 조회 시
✅ 빌트인 현관중문 (타입: "84A,84B" - 84A 포함)
✅ 가전 김치냉장고 (타입: "전체")
❌ 발코니확장 (필터링으로 제외)
```

---

### 3️⃣ 분양가 추출 프롬프트 개선

**변경 전**: 동/호 구분까지 추출
**변경 후**: 타입 × 층별로만 추출 + 15개 금액 항목 추출

**추출 항목** (총 15개):
1. 대지비
2. 건축비
3. 부가가치세
4. 분양가
5. 1차 계약금
6. 2차 계약금
7. 중도금 1~6회 (6개)
8. 잔금

**프롬프트 파일**: `prompts/extract_pricing.md`

---

### 4️⃣ 층 파싱 로직 강화

**추가 처리 케이스**:
- `"최상"`, `"최고"` → 99층으로 처리
- `"최하"`, `"최저"` → 1층으로 처리
- 모든 파싱 오류에 try-except 추가

**관련 파일**: `src/collectors/pdf_to_data.py` - `_parse_floor_range()` 메서드

---

### 5️⃣ Google Cloud 로깅 경고 숨김

**추가된 코드**:
```python
# Google Cloud 로깅 경고 메시지 숨기기
os.environ['GRPC_VERBOSITY'] = 'ERROR'
os.environ['GLOG_minloglevel'] = '2'
```

**효과**: 터미널 실행 시 `ALTS creds ignored` 경고 메시지 제거

---

## 📊 데이터 구조 변경

### 옵션 CSV 구조 (최종)

```csv
단지명,옵션구분,타입,품목,품목세부,설치내역,공급금액
아산모종,발코니확장,84A,발코니확장,,발코니 확장,10000000
아산모종,빌트인,"84A,84B",현관중문,3연동 슬라이딩 도어,현관,880000
아산모종,가전,"전체",김치냉장고,LG 디오스,주방,800000
```

**특징**:
- 발코니도 옵션 CSV에 포함 (별도 파일 없음)
- 타입 컬럼에 쉼표 구분 복수 타입 가능
- "전체" 타입으로 모든 타입 공통 옵션 표현

---

## 🔧 Google Sheets 수식 (제안)

### C11 발코니 금액 조회 수식

```excel
=ROUNDDOWN(
  INDEX(IMPORTRANGE(B1, "옵션!G:G"),
    MATCH(1,
      (IMPORTRANGE(B1, "옵션!A:A")=C4)*
      (IMPORTRANGE(B1, "옵션!B:B")="발코니확장")*
      (IMPORTRANGE(B1, "옵션!C:C")=C7),
    0)
  )/10000, 0
)
```

**동작**:
- 옵션 시트에서 단지명(C4) + 옵션구분("발코니확장") + 타입(C7) 조건으로 조회
- 공급금액(G열)을 만 단위로 변환하여 표시

---

## 📂 수정된 파일 목록

### Python 코드
- `src/collectors/pdf_to_data.py`
  - `_extract_pricing()`: 15개 금액 항목 추출, 세대정보 매핑 로직
  - `_parse_floor_range()`: 층 파싱 강화 ("최상", "최하" 처리)
  - `_extract_balcony()`: 삭제
  - `extract_all_data()`: 5단계 → 4단계로 변경
  - `main()`: UTF-8 인코딩 설정 추가

### 프롬프트
- `prompts/extract_pricing.md`: 15개 금액 항목 추출 프롬프트

### Google Apps Script
- `apps-script/통합_최종_스크립트_v2_개선.js`
  - `processOptionDataFromExternalSheet()`: 타입 매칭 로직 개선, 발코니 제외

---

## 🎯 개선 효과

### 데이터 효율성
- **CSV 용량 감소**: 타입별 중복 제거로 1/10 수준 (예: 5개 타입 × 10개 옵션 = 50행 → 10행)
- **유지보수성 향상**: 옵션 금액 변경 시 1곳만 수정

### 사용자 경험
- **발코니 자동 적용**: 필수 옵션이므로 별도 선택 불필요
- **전체 옵션 자동 포함**: 모든 타입 공통 옵션 자동 적용

### 시스템 안정성
- **층 파싱 오류 감소**: 다양한 표현 방식 처리
- **로깅 정리**: 불필요한 경고 메시지 제거

---

## 🚨 주의사항

1. **Google Sheets 스크립트 업데이트 필요**
   - `apps-script/통합_최종_스크립트_v2_개선.js` 내용을
   - Google Sheets > 확장 프로그램 > Apps Script에 복사

2. **C11 수식 업데이트**
   - 등록검색 시트 C11에 새 발코니 조회 수식 입력

3. **기존 발코니 CSV 처리**
   - 기존 별도 발코니 CSV 파일은 참고용으로 보관
   - 신규 데이터는 옵션 CSV 사용

---

## 📝 후속 작업

- [ ] Google Sheets 스크립트 업데이트 확인
- [ ] C11 발코니 수식 동작 확인
- [ ] 신규 아파트 PDF 추출 테스트
- [ ] 옵션 데이터 정합성 검증

---

## 📚 참고 자료

- [프로젝트 허브](30.%20OKR/03.%20Project/구글%20스프레드시트%20자동화%20매물관리%20시스템구축/code/README.md)
- [Google Apps Script 가이드](../구글_스프레드시트_자동화_매물관리_시스템구축.md)
- [PDF 추출 가이드](../PDF_데이터_자동_추출_가이드.md)
