# AppSheet 매물관리 시스템 설정 요약

작업일: 2025-10-30

## 1. 고객 ID 수식 (D_C_ID)

### 목적
고객 구분에 따라 다른 형식의 ID 자동 생성

### 수식
```
IF(
  IN([고객구분], "대행사", "부동산"),
  CONCATENATE([이름], " ", [직급]),
  CONCATENATE(
    CONCATENATE(
      INDEX([Related 아파트매물s][D_AD_ID], 1),
      INDEX([Related 상가s][D_C_ID], 1),
      INDEX([Related 원투룸s][D_OR_ID], 1),
      INDEX([Related 공장창고s][D_F_ID], 1),
      INDEX([Related 토지s][D_L_ID], 1),
      INDEX([Related 주택타운s][D_H_ID], 1),
      INDEX([Related 건물s][D_B_ID], 1)
    ),
    "_",
    [고객구분],
    "_",
    RIGHT([연락처], 4)
  )
)
```

### 결과 예시
- 대행사/부동산: `"홍길동 과장"`
- 일반 고객: `"AD001_101_1501_매수인_5678"`

---

## 2. 매물별 디스플레이 ID (D_X_ID)

### 공장(F) - D_F_ID
```
CONCATENATE(
  IF(
    ISNOTBLANK([통반리]),
    CONCATENATE([통반리], " ", [지번]),
    IF(
      ISNOTBLANK([동읍면]),
      CONCATENATE([동읍면], " ", [지번]),
      CONCATENATE([시군구], " ", [지번])
    )
  ),
  "-",
  [용도지역],
  "-",
  [지목]
)
```

**결과:** `"판교동 123-45-용도지역-대지"`

---

### 토지(L) - D_L_ID
```
CONCATENATE(
  IF(ISNOTBLANK([통반리]), [통반리], IF(ISNOTBLANK([동읍면]), [동읍면], [시군구])),
  " ",
  [지번],
  "-",
  [용도지역],
  "-",
  [지목]
)
```

**결과:** `"판교동 123-45-용도지역-임야"`

---

### 주택(H) - D_H_ID
```
IF(
  [주택단지] = "단독",
  CONCATENATE(
    [주택단지],
    " ",
    [동읍면],
    IF(ISNOTBLANK([통반리]), CONCATENATE(" ", [통반리]), ""),
    " ",
    [지번]
  ),
  CONCATENATE(
    [주택단지],
    IF(ISNOTBLANK([타입]), CONCATENATE(" ", [타입]), ""),
    IF(ISNOTBLANK([동]), CONCATENATE(" ", [동]), ""),
    IF(ISNOTBLANK([호]), CONCATENATE(" ", [호]), "")
  )
)
```

**결과:**
- 일반: `"캠스베일리1차 84A 101동 1501호"`
- 단독: `"단독 분당구 판교동 123-45"`

---

## 3. 거래 가격 디스플레이 수식 (DP거래)

### 아파트매물
```
TRIM(
  CONCATENATE(
    IF(
      OR(IN("매매", [거래유형]), IN("분양", [거래유형])),
      CONCATENATE(
        IF(
          [합계] > 0,
          CONCATENATE(IF(IN("분양", [거래유형]), "분양 ", "매매 "), TEXT([합계])),
          IF(ISNOTBLANK([매매가]), CONCATENATE("매매 ", TEXT([매매가])), "")
        ),
        " "
      ),
      ""
    ),
    IF(IN("전세", [거래유형]), CONCATENATE("전세 ", TEXT([전세가]), " "), ""),
    IF(IN("월세", [거래유형]), CONCATENATE("보 ", TEXT([보증금]), " 월 ", TEXT([월세])), "")
  )
)
```

**결과:**
- `"매매 50,000"`
- `"전세 30,000"`
- `"매매 50,000 전세 30,000"`
- `"보 5,000 월 150"`

---

### 상가/원투룸/주택
```
TRIM(
  CONCATENATE(
    IF(IN("매매", [거래유형]), CONCATENATE("매매 ", TEXT([매매가]), " "), ""),
    IF(IN("전세", [거래유형]), CONCATENATE("전세 ", TEXT([전세가]), " "), ""),
    IF(IN("월세", [거래유형]), CONCATENATE("보 ", TEXT([보증금]), " 월 ", TEXT([월세])), "")
  )
)
```

---

### 공장/토지
```
TRIM(
  CONCATENATE(
    IF(IN("매매", [거래유형]), CONCATENATE("매매 ", TEXT([매매가]), " "), ""),
    IF(IN("임대", [거래유형]), CONCATENATE("임대 ", TEXT([임대료]), " "), "")
  )
)
```

---

## 4. 주소 자동 입력 (건물 참조)

### 상가 테이블 - 주소 자동 입력
```
CONCATENATE(
  [건물명].[시도],
  " ",
  [건물명].[시군구],
  " ",
  [건물명].[동읍면],
  IF(ISNOTBLANK([건물명].[통반리]), CONCATENATE(" ", [건물명].[통반리]), ""),
  " ",
  [건물명].[지번]
)
```

**결과:** `"서울특별시 강남구 역삼동 123-45"`

---

## 5. 임대인 연락처 자동 입력

### 각 매물 테이블 - 임대인 연락처 컬럼

**원래 수식 (수정 필요):**
```
IF([고객].[고객구분] = "매도임대인", [고객].[연락처], "")
```

**추천 수식 (포용적):**
```
IF(IN([고객].[고객구분], "임대인", "매도임대인"), [고객].[연락처], "")
```

---

## 6. 시스템 아키텍처 결정

### 선택: 단일 앱 구조 ⭐⭐⭐⭐⭐

**구조:**
```
매물관리 앱
├── 테이블
│   ├── 아파트매물
│   ├── 상가매물
│   ├── 원투룸
│   ├── 주택
│   ├── 공장
│   ├── 토지
│   ├── 고객DB
│   ├── 건물
│   └── 통합매물DB (Apps Script 자동 동기화)
├── 뷰
│   ├── 각 매물별 리스트/상세뷰
│   ├── 🗺️ 통합 지도뷰 (통합매물DB)
│   └── 📊 대시보드
└── 액션
    └── 통합DB 새로고침
```

**장점:**
- 데이터 일관성 보장
- 크로스 참조 쉬움
- 사용자 경험 우수
- 권한 관리 단순
- 개발/유지보수 효율

---

## 7. 통합매물DB Apps Script

### Google Sheets Apps Script

```javascript
function 통합DB_업데이트() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var 통합시트 = ss.getSheetByName('통합DB');

  if (!통합시트) {
    Logger.log('통합DB 시트를 찾을 수 없습니다.');
    return;
  }

  // 기존 데이터 삭제 (헤더 제외)
  var lastRow = 통합시트.getLastRow();
  if (lastRow > 1) {
    통합시트.getRange(2, 1, lastRow - 1, 통합시트.getLastColumn()).clearContent();
  }

  var 통합데이터 = [];
  var 현재시간 = new Date();

  // 각 매물 시트 정보
  var 매물시트목록 = [
    {
      이름: '아파트매물',
      유형: '아파트',
      ID컬럼: 'D_AD_ID',
      주소컬럼: '전체주소',
      상태컬럼: '상태',
      가격컬럼: '매매가'
    },
    {
      이름: '상가매물',
      유형: '상가',
      ID컬럼: 'D_C_ID',
      주소컬럼: '주소',
      상태컬럼: '상태',
      가격컬럼: '보증금'
    },
    // ... 다른 매물 추가
  ];

  // 각 매물 시트에서 데이터 수집
  매물시트목록.forEach(function(매물정보) {
    var 시트 = ss.getSheetByName(매물정보.이름);

    if (!시트) {
      Logger.log(매물정보.이름 + ' 시트를 찾을 수 없습니다.');
      return;
    }

    var 데이터 = 시트.getDataRange().getValues();
    var 헤더 = 데이터[0];

    // 컬럼 인덱스 찾기
    var ID인덱스 = 헤더.indexOf(매물정보.ID컬럼);
    var 주소인덱스 = 헤더.indexOf(매물정보.주소컬럼);
    var 상태인덱스 = 헤더.indexOf(매물정보.상태컬럼);
    var 가격인덱스 = 헤더.indexOf(매물정보.가격컬럼);

    // 데이터 행 처리
    for (var i = 1; i < 데이터.length; i++) {
      var 행 = 데이터[i];

      if (행[ID인덱스] && 행[주소인덱스]) {
        통합데이터.push([
          행[ID인덱스],                    // 매물ID
          매물정보.유형,                     // 매물유형
          행[주소인덱스],                    // 주소
          상태인덱스 !== -1 ? 행[상태인덱스] : '',
          가격인덱스 !== -1 ? 행[가격인덱스] : '',
          매물정보.이름,                     // 원본테이블
          행[ID인덱스],                    // 원본ID
          현재시간                         // 최종수정일
        ]);
      }
    }
  });

  // 통합 데이�� 쓰기
  if (통합데이터.length > 0) {
    통합시트.getRange(2, 1, 통합데이터.length, 8).setValues(통합데이터);
    Logger.log('통합DB 업데이트 완료: ' + 통합데이터.length + '개 매물');
  }
}
```

**트리거 설정:**
- 시간 기반: 매 1시간마다 실행
- 또는 수동 실행

---

## 8. 시각화 전략

### 추천: 가상 컬럼 + 최소 Format Rules

**거래유형표시 가상 컬럼 (각 매물 테이블):**
```
CONCATENATE(
  LIST(
    IF(IN("매매", [거래유형]), "🔴 매매", ""),
    IF(IN("전세", [거래유형]), "🔵 전세", ""),
    IF(IN("월세", [거래유형]), "🟢 월세", ""),
    IF(IN("분양", [거래유형]), "🟠 분양", "")
  ),
  ", "
)
```

**Format Rules (최소 2개):**
1. 계약완료: 회색 배경
2. 급매: 빨강 배경

**장점:**
- 기존 수식 수정 불필요
- 성능 영향 최소
- 시각적 구분 충분

---

## 9. 딥링크 (공유 링크)

### 공유URL 가상 컬럼 (각 매물 테이블)

**아파트매물:**
```
CONCATENATE(
  "https://www.appsheet.com/start/",
  CONTEXT("AppKey"),
  "#view=아파트매물_상세&row=",
  ENCODEURL([D_AD_ID])
)
```

**사용:**
- 매물 상세 페이지에서 URL 복사
- 카카오톡/이메일로 공유
- 받은 사람이 클릭하면 바로 해당 매물 페이지 열림

---

## 10. 리소스 최적화 가이드

### 성능 영향도

| 요소 | 개수 | 성능 영향 | 권장 |
|------|------|-----------|------|
| **가상 컬럼** | 무제한 | 거의 없음 | ⭐⭐⭐⭐⭐ |
| **Format Rules** | 3-5개 | 약간 | ⭐⭐⭐⭐ |
| **Format Rules** | 10개+ | 눈에 띔 | ⭐⭐ |
| **Complex 수식** | 적을수록 | 중간 | ⭐⭐⭐ |

### 권장 사항
- ✅ 가상 컬럼 적극 활용 (성능 우수)
- ✅ Format Rules 3-5개 이하로 제한
- ✅ 복잡한 수식보다 여러 단순 수식
- ✅ 표시용과 계산용 컬럼 분리

---

## 다음 작업 계획

### 우선순위 1 (즉시)
- [ ] 각 매물 테이블에 DP거래 컬럼 적용
- [ ] 각 매물 테이블에 D_X_ID 수식 적용
- [ ] 고객DB에 D_C_ID 수식 적용

### 우선순위 2 (단기)
- [ ] 통합매물DB Apps Script 작성 및 테스트
- [ ] 통합 지도뷰 생성
- [ ] 거래유형표시 가상 컬럼 추가

### 우선순위 3 (중기)
- [ ] Format Rules 2-3개 추가
- [ ] 공유URL 컬럼 추가
- [ ] 대시보드 뷰 구성

### 향후 검토
- [ ] QR 코드 생성
- [ ] 매물 추천 시스템
- [ ] 자동 리포트 기능

---

## 참고 자료

### 컬럼명 일관성

**매물 ID 패턴:**
- 아파트: `D_AD_ID` (Apartment Development)
- 상가: `D_C_ID` (Commercial)
- 원투룸: `D_OR_ID` (One Room)
- 주택: `D_H_ID` (House)
- 공장: `D_F_ID` (Factory)
- 토지: `D_L_ID` (Land)
- 건물: `D_B_ID` (Building)
- 고객: `D_C_ID` (Customer)

**공통 컬럼:**
- 거래유형: EnumList ("매매", "전세", "월세", "분양")
- 거래상태: Enum ("판매중", "계약완료", "보류", "급매")
- DP거래: 가상 컬럼 (디스플레이용)

---

## 문의/수정 필요 사항

### 확인 필요
1. 각 매물 테이블의 실제 컬럼명 확인
2. 거래상태 Enum 값 확인
3. 뷰 이름 확인 (지도뷰, 상세뷰 등)

### 커스터마이징
- 매물별 특수 요구사항
- 추가 계산 필드
- 특정 워크플로우 자동화

---

**작성:** Claude Code
**날짜:** 2025-10-30
**버전:** 1.0
