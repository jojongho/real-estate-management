# 통합매매 건물 수익률 계산 시스템 구현 가이드

## 📋 개요

통매매 건물(상가+원투룸 포함)의 수익률을 자동 계산하기 위한 AppSheet 시스템 구현 가이드입니다.

**작성일**: 2025-01-13
**대상**: 건물 테이블 (매물관리 AppSheet)

---

## 🎯 시스템 구성

### 1. 데이터 구조

#### 건물 테이블
- **매매가**: 건물 총 매매 가격
- **보증금**: 상가 보증금 + 원투룸 전세가 + 원투룸 보증금 합계
- **임대료**: 상가 임대료 + 원투룸 임대료 합계
- **대출금액**: 은행 대출금 (비율 또는 직접 입력)
- **대출비율**: 매매가 대비 대출 비율 (예: 60%)
- **금리**: 대출 금리 (예: 4% = 0.04)

#### 상가 테이블 (Ref 연결)
- 건물명 (Ref)
- 보증금
- 임대료 (관리금)

#### 원투룸 테이블 (Ref 연결)
- 건물명 (Ref)
- 전세가
- 보증금
- 임대료

---

## ⚙️ Action 구현: 통매매 금액 자동 합산

### Action 설정

**Action 이름**: `통매매 금액 자동 합산`

#### 기본 설정
- **For a record of this table**: `건물`
- **Do this**: `Data: set the values of some columns in this row`

#### Set these columns

| Column | Value (수식) |
|--------|-------------|
| `보증금` | `SUM(SELECT(상가[보증금], [건물명] = [_THISROW].[ID])) + SUM(SELECT(원투룸[전세가], [건물명] = [_THISROW].[ID])) + SUM(SELECT(원투룸[보증금], [건물명] = [_THISROW].[ID]))` |
| `임대료` | `SUM(SELECT(상가[임대료], [건물명] = [_THISROW].[ID])) + SUM(SELECT(원투룸[임대료], [건물명] = [_THISROW].[ID]))` |

#### Display 설정
- **Position**: `Prominent`
- **Display name**: `건물 매매 자동합산` 또는 `💰 금액 합산`
- **Action icon**: `money` 💰

#### Behavior 설정
- **Needs confirmation?**: ✅ ON
- **Confirmation Message**: `건물에 속한 값을 자동계산 하시겠습니까?`

---

## 📐 Formula 구현: 수익률 자동 계산

### 칼럼별 App Formula

#### 1. 대출금액 (Price)
```appsheet
IF(AND(ISNOTBLANK([대출비율]), [대출비율] > 0),
   [매매가] * [대출비율],
   [대출금액]
)
```

**로직**:
- 대출비율이 입력되면: 매매가 × 대출비율
- 아니면: 직접 입력된 대출금액 사용

---

#### 2. 실투자금 (Price)
```appsheet
[매매가] - [대출금액] - [보증금]
```

**로직**:
- 매매가 - 대출금액 - 보증금 = 실제 투자금

---

#### 3. 월이자 (Price)
```appsheet
[대출금액] * [금리] / 12
```

**로직**:
- 대출금액에 대한 월 이자 지출

---

#### 4. 연이자 (Price)
```appsheet
[대출금액] * [금리]
```

**로직**:
- 대출금액에 대한 연 이자 지출

---

#### 5. 월수익 (Price)
```appsheet
[임대료]
```

**로직**:
- 순수 월세 수익 (보증금 이자 제외)

---

#### 6. 연수익 (Price)
```appsheet
[월수익] * 12
```

**로직**:
- 순수 연 임대 수익

---

#### 7. 월순수익 (Price)
```appsheet
[월수익] - [월이자]
```

**로직**:
- 월세 수익 - 대출 이자 지출

---

#### 8. 연순수익 (Price)
```appsheet
[연수익] - [연이자]
```

**로직**:
- 연 임대 수익 - 연 대출 이자

---

#### 9. 수익률 (Percent)
```appsheet
IF([실투자금] > 0,
   [연순수익] / [실투자금],
   0
)
```

**로직**:
- 실투자금 대비 연순수익 비율
- Type이 Percent이므로 자동으로 % 표시

---

## 🧮 계산 예시

### 입력 데이터
```
매매가: 100,000만원
대출비율: 60%
금리: 4% (0.04)

상가:
- 보증금: 5,000만원
- 임대료: 150만원

원투룸 (10호):
- 전세가 합계: 10,000만원
- 보증금 합계: 5,000만원
- 임대료 합계: 150만원
```

### "통매매 금액 자동 합산" 버튼 클릭
```
보증금 = 5,000 + 10,000 + 5,000 = 20,000만원
임대료 = 150 + 150 = 300만원
```

### 자동 계산 결과
```
대출금액 = 100,000 × 0.6 = 60,000만원
실투자금 = 100,000 - 60,000 - 20,000 = 20,000만원

월이자 = 60,000 × 0.04 ÷ 12 = 200만원
연이자 = 60,000 × 0.04 = 2,400만원

월수익 = 300만원
연수익 = 300 × 12 = 3,600만원

월순수익 = 300 - 200 = 100만원
연순수익 = 3,600 - 2,400 = 1,200만원

수익률 = 1,200 ÷ 20,000 = 6% (0.06)
```

---

## 🔧 구현 단계

### Step 1: Action 생성
1. AppSheet Editor → **Behavior** → **Actions**
2. **+ New Action** 클릭
3. Action 설정 입력 (위 참조)
4. **Save**

### Step 2: Formula 입력
1. AppSheet Editor → **Data** → **Columns**
2. **건물** 테이블 선택
3. 각 칼럼 클릭 → **FORMULA** 입력
4. **Save**

### Step 3: 칼럼 설정 확인
각 계산 칼럼의 설정:
- **EDITABLE?**: ✅ 체크 (수동 수정 가능)
- **SHOW?**: ✅ 체크 (화면 표시)
- **Type**: 올바른 타입 설정 (Price, Percent 등)

### Step 4: 테스트
1. Preview 모드 실행
2. 건물 레코드 생성/수정
3. 매매가, 대출비율, 금리 입력
4. 상가/원투룸 데이터 입력
5. "통매매 금액 자동 합산" 버튼 클릭
6. 모든 계산 값 확인

---

## ⚠️ 주의사항

### 1. 금리 타입
- **Percent 타입**: 1.5% 입력 시 0.015로 저장됨
- 수식에서 `/100` 제거
- 현재 설정이 Percent이므로 위 수식 사용

### 2. 대출금액 처리
- 대출비율 입력 시: 자동 계산
- 대출금액 직접 입력 시: 입력값 우선
- 둘 다 입력된 경우: 대출금액이 우선

### 3. App Formula 특성
- 다른 칼럼 변경 시 자동 재계산
- 수동으로 값 수정 가능 (EDITABLE 체크 시)
- Google Sheets에 실제로 저장됨

### 4. 건물 참조 확인
- 상가/원투룸 테이블의 건물 참조 칼럼명 확인
- 현재: `건물명` (Ref)
- 건물 테이블의 ID와 매칭됨

---

## 📊 브리핑용 확장 (향후)

### 보증금 이자 수익 포함
현재는 순수 임대소득만 계산합니다.
브리핑 시 보증금 예치 이자를 포함하려면:

#### 별도 시트에서 계산
```
은행예치 금리: 3% (고객별 조정 가능)

보증금 이자 = 20,000 × 0.03 ÷ 12 = 50만원
총 월수익 = 300 + 50 = 350만원

조정 월순수익 = 350 - 200 = 150만원
조정 연순수익 = 1,800만원
조정 수익률 = 1,800 ÷ 20,000 = 9%
```

---

## 🎯 시스템 특징

### 장점
- ✅ **자동화**: 버튼 클릭으로 보증금/임대료 합산
- ✅ **유연성**: 대출비율 또는 금액 직접 입력 가능
- ✅ **정확성**: 실투자금 기준 수익률 계산
- ✅ **객관성**: 순수 임대소득 기준 (보증금 이자 제외)
- ✅ **수동 수정**: 필요 시 모든 값 직접 수정 가능

### 활용
- 건물 매물 수익률 분석
- 고객 투자 제안서 작성
- 매물 간 수익성 비교
- 대출 조건별 시뮬레이션

---

## 📝 참고 문서

- [통합DB_QUERY_수식_가이드.md](./통합DB_QUERY_수식_가이드.md)
- [CLAUDE.md](../CLAUDE.md) - 프로젝트 전체 가이드

---

**문서 버전**: 1.0
**최종 수정**: 2025-01-13
